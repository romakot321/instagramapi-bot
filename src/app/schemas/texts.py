import mimetypes
import datetime as dt
import humanize
import re

from api.services import tracking
from app.schemas.instagram import (
    InstagramMediaSchema,
    InstagramMediaStatsSchema,
    InstagramMediaUserStatsSchema,
    InstagramUserSchema,
    InstagramUserStatsSchema,
)
from db.tables import Subscription, TrackingMedia


def descape_markdown(text: str) -> str:
    for i in "_*[]()~`>#+-=|{}.!":
        text = text.replace(i, f"\\{i}{i}")
    return text


def escape_markdown(text: str) -> str:
    escape_chars = r"_*[]()~`>#+-=|{}.!"
    ret = re.sub(r"([{}])".format(re.escape(escape_chars)), r"\\\1", text)
    for i in "_*[]()~`>#+-=|{}.!":
        ret = ret.replace(f"\\{i}\\{i}", i)
    return ret


_start_text = """
ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² [ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ°] â€“ Ñ‚Ğ²Ğ¾Ğ¹ Ğ½ĞµĞ·Ğ°Ğ¼ĞµĞ½Ğ¸Ğ¼Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ´Ğ»Ñ Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Instagram, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ñ‹Ğ²ĞµÑÑ‚Ğ¸ Ñ‚Ğ²Ğ¾Ğ¹ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ!

**Ğ¡ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ğ½Ğ°ÑˆĞµĞ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ° Ñ‚Ñ‹ ÑĞ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ¸ Ğ»ĞµĞ³ĞºĞ¾ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸:**
ğŸ“ˆ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ğ¹ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½Ñƒ Ñ€Ğ¾ÑÑ‚Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ² Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¸Ğ½ÑĞ°Ğ¹Ñ‚Ñ‹ Ğ´Ğ»Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°.
â¤ï¸ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ğ»Ğ°Ğ¹ĞºĞ¸ Ğ¸ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ»ÑƒÑ‡ÑˆĞµ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ ÑĞ²Ğ¾ĞµĞ¹ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸.
ğŸ“Š Ğ˜Ğ·ÑƒÑ‡Ğ°Ğ¹ Ğ²Ğ¾Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ²Ğ¾Ğ·Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ.
ğŸ“… ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞ¹ Ğ»ÑƒÑ‡ÑˆĞ¸Ğµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¹ Ğ¸ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°Ğ¹ Ğ¾Ñ…Ğ²Ğ°Ñ‚ ÑĞ²Ğ¾ĞµĞ¹ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸.

Ğ˜ ÑÑ‚Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ â€” **Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ» Ğ±ÑƒĞ´ĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒÑÑ ĞµÑ‰Ğµ Ğ¼Ğ¾Ñ‰Ğ½ĞµĞµ!**

**Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ… ÑˆĞ°Ğ³Ğ¾Ğ²:**

1. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°, Ğ½Ğ°Ğ¶Ğ°Ğ² Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ". Ğ¢Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸ÑˆÑŒ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ ÑĞ»ĞµĞ´Ğ¸Ñ‚ÑŒ Ğ·Ğ° Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ğ¼Ğ¸ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°Ğ¼Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾!
2. ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°", Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ÑĞ²Ğ¾ĞµĞ³Ğ¾ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°, Ğ½Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸.

ĞĞµ ÑƒĞ¿ÑƒÑÑ‚Ğ¸ ÑˆĞ°Ğ½Ñ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ğ¹ Instagram ÑƒÑĞ¿ĞµÑˆĞ½ĞµĞµ! __Ğ“Ğ¾Ñ‚Ğ¾Ğ² ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ ÑĞ²Ğ¾Ğ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹?__ ğŸ’ª

**Ğ’Ğ°Ñˆ Chat ID: {chat_id}**
"""


_support_text = """
ĞŸĞ¾ Ğ²ÑĞµĞ¼ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼ Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°Ğ¹Ñ‚ĞµÑÑŒ Ğ² ÑĞ»ÑƒĞ¶Ğ±Ñƒ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ ğŸ‘‰ [support_contact]
"""
support_text = escape_markdown(_support_text)


_tracking_info_text = """
ğŸ“±  ĞĞ¸ĞºĞ½ĞµĞ¹Ğ¼: {schema.username}
ğŸ”—  Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚: [[{schema.username}]]((https://instagram.com/{schema.username}))
ğŸ“›  Ğ˜Ğ¼Ñ: {schema.full_name}
ğŸ§‘â€ğŸ’»  ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ²: {schema.followers_count}
â­ï¸  ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº: {schema.following_count}
ğŸ–¼  ĞŸĞ¾ÑÑ‚Ğ¾Ğ²: {schema.media_count}
â„¹ï¸  ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: {biography}
"""

_tracking_info_masked_text = """
ĞĞ¸ĞºĞ½ĞµĞ¹Ğ¼: {schema.username}
Ğ˜Ğ¼Ñ: {schema.full_name}
ĞŸĞ¾ÑÑ‚Ğ¾Ğ²: ||||ÑĞºÑ€Ñ‹Ñ‚Ğ¾||||
ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ²: {schema.followers_count}
ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº: {schema.following_count}

Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:
ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²: ||||ÑĞºÑ€Ñ‹Ñ‚Ğ¾||||
Ğ’ ÑÑ€ĞµĞ´Ğ½ĞµĞ¼ Ğ»Ğ°Ğ¹ĞºĞ¾Ğ² Ğ½Ğ° Ğ¿Ğ¾ÑÑ‚: ||||ÑĞºÑ€Ñ‹Ñ‚Ğ¾||||
Ğ’ ÑÑ€ĞµĞ´Ğ½ĞµĞ¼ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ² Ğ½Ğ° Ğ¿Ğ¾ÑÑ‚: ||||ÑĞºÑ€Ñ‹Ñ‚Ğ¾||||
ĞšĞ¾ÑÑ„. Ğ²Ğ¾Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸: ||||ÑĞºÑ€Ñ‹Ñ‚Ğ¾||||

ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞºÑ€Ñ‹Ñ‚Ñ‹. Ğ”Ğ»Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° Ğ¿Ñ€Ğ¸Ğ¾Ğ±Ñ€ĞµÑ‚Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ
"""

_tracking_stats_text = """
ğŸ“Š **Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°**:
ğŸ–¼ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²: {media_count}
ğŸ‘ Ğ’ ÑÑ€ĞµĞ´Ğ½ĞµĞ¼ Ğ»Ğ°Ğ¹ĞºĞ¾Ğ² Ğ½Ğ° Ğ¿Ğ¾ÑÑ‚: {media_likes}
âŒ¨ï¸ Ğ’ ÑÑ€ĞµĞ´Ğ½ĞµĞ¼ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ² Ğ½Ğ° Ğ¿Ğ¾ÑÑ‚: {media_comments}
ğŸ¤” ĞĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾ÑÑ„. Ğ²Ğ¾Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸: {weekly_media_coeff}%
ğŸ¤” ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾ÑÑ„. Ğ²Ğ¾Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸: {monthly_media_coeff}%

ğŸ“Š **Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ {change.previous_stats_date:%d.%m.%Y %H:%M}**
ğŸ–¼ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²: {media_count_difference}
ğŸ§‘â€ğŸ’» Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ²: {followers_count_difference}
â­ï¸ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº: {following_count_difference}
"""

_private_tracking_text = """
ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ {schema.username} Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚.
"""

_tracking_not_found_text = """
ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ {tracking_username} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.
"""

_tracking_follower_text = """[[{tracking}]]((https://instagram.com/{tracking}))"""

_tracking_report_text = """
ĞÑ‚Ñ‡ĞµÑ‚ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: {tracking.username}

Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚: [[{tracking.username}]]((https://instagram.com/{tracking.username}))

ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¾Ñ‚ {change.previous_stats_date:%d.%m.%Y %H:%M}

ğŸ–¼ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²: ğŸ”¼{media_count} ({change.media_count_difference})
ğŸ§‘â€ğŸ’» ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ²: ğŸ”½{tracking.followers_count} ({change.followers_count_difference})
â­ï¸ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº: ğŸ”¼{tracking.following_count} ({change.following_count_difference})
"""

_tracking_unsubscribe_text = """
Ğ’Ñ‹ Ğ¾Ñ‚Ğ¿Ğ¸ÑĞ°Ğ»Ğ¸ÑÑŒ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ [[{tracking_username}]]((https://instagram.com/{tracking_username})).
**Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ Ğ½Ğ° Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ Ğ¼ĞµÑÑÑ† Ğ¸Ğ»Ğ¸ ĞºÑƒĞ¿Ğ¸Ñ‚Ğµ Ğ´Ğ¾Ğ¿. Ğ¿Ğ°ĞºĞµÑ‚.**.
Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {tracking_username} Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ² Ğ»ÑĞ±Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ, Ğ¿Ğ¾ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°.
"""

_tracking_subscribe_text = """
Ğ’Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ»Ğ¸ÑÑŒ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ [[{tracking_username}]]((https://instagram.com/{tracking_username})).
Ğ’Ğ°Ğ¼ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ€Ğ°Ğ· Ğ² {report_interval}, Ğ½Ğ¾ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ ÑĞ±Ğ¾Ñ€Ğ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¾Ğ²
"""


def build_start_text(chat_id: int) -> str:
    text = _start_text.format(chat_id=chat_id)
    return escape_markdown(text)


def build_tracking_subscribe_text(tracking_username: str, report_interval: int) -> str:
    report_interval = humanize.naturaldelta(dt.timedelta(seconds=int(report_interval)))
    text = _tracking_subscribe_text.format(tracking_username=tracking_username, report_interval=report_interval)
    return escape_markdown(text)


def build_tracking_unsubscribe_text(tracking_username: str) -> str:
    text = _tracking_unsubscribe_text.format(tracking_username=tracking_username)
    return escape_markdown(text)


def build_tracking_not_found_text(tracking_username: str) -> str:
    return _tracking_not_found_text.format(tracking_username=tracking_username)


def build_tracking_private_text(schema: InstagramUserSchema) -> str:
    return _private_tracking_text.format(schema=schema)


def build_big_tracking_info_text(schema: InstagramUserSchema) -> str:
    return (
        build_tracking_info_text(schema=schema)
        + "\nâ—ï¸ Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿"
    )


def build_tracking_info_text(schema: InstagramUserSchema) -> str:
    biography = descape_markdown(schema.biography if schema.biography else "")
    return escape_markdown(_tracking_info_text.format(schema=schema, biography=biography))


def build_tracking_info_masked_text(schema: InstagramUserSchema) -> str:
    return escape_markdown(_tracking_info_masked_text.format(schema=schema))


def build_tracking_stats_text(
    change: InstagramUserStatsSchema,
    weekly: InstagramMediaUserStatsSchema,
    monthly: InstagramMediaUserStatsSchema,
    tracking: InstagramUserSchema,
) -> str:
    followers_count_difference = "0"
    if change.followers_count_difference > 0:
        followers_count_difference = f"ğŸ”¼ (+{change.followers_count_difference})"
    elif change.followers_count_difference < 0:
        followers_count_difference = f"ğŸ”½ ({change.followers_count_difference})"

    following_count_difference = "0"
    if change.following_count_difference > 0:
        following_count_difference = f"ğŸ”¼ (+{change.following_count_difference})"
    elif change.following_count_difference < 0:
        following_count_difference = f"ğŸ”½ ({change.following_count_difference})"

    media_count_difference = "0"
    if change.media_count_difference > 0:
        media_count_difference = f"ğŸ”¼ (+{change.media_count_difference})"
    elif change.media_count_difference < 0:
        media_count_difference = f"ğŸ”½ ({change.media_count_difference})"

    text = _tracking_stats_text.format(
        media_count=weekly.count,
        media_likes=round(weekly.like_count_sum / weekly.count, 2) if weekly.count else 0,
        media_comments=round(weekly.comment_count_sum / weekly.count, 2) if weekly.count else 0,
        weekly_media_coeff=round(
            (weekly.like_count_sum + weekly.comment_count_sum)
            / tracking.followers_count
            * 100,
            2,
        ),
        monthly_media_coeff=round(
            (monthly.like_count_sum + monthly.comment_count_sum)
            / tracking.followers_count
            * 100,
            2,
        ),
        change=change,
        media_count_difference=media_count_difference,
        followers_count_difference=followers_count_difference,
        following_count_difference=following_count_difference
    )
    return escape_markdown(text)


def build_tracking_following_text(following: list[str]) -> str:
    return build_tracking_followers_text(following)


def build_tracking_followers_text(followers: list[str]) -> str:
    if not followers:
        return escape_markdown("Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿ÑƒÑÑ‚. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ±ĞµÑ€ÑƒÑ‚ÑÑ")
    return "\n".join(
        f"[{tracking}](https://instagram.com/{tracking})"
        for tracking in map(lambda i: escape_markdown(i), followers)
    )


def build_tracking_report_text(
    change: InstagramUserStatsSchema,
    current: InstagramMediaUserStatsSchema,
    tracking: InstagramUserSchema,
) -> str:
    text = _tracking_report_text.format(
        media_count=current.count,
        media_likes=round(current.like_count_sum / current.count, 2),
        media_comments=round(current.comment_count_sum / current.count, 2),
        media_coeff=round(
            (current.like_count_sum + current.comment_count_sum)
            / tracking.followers_count
            * 100,
            2,
        ),
        change=change,
        tracking=tracking,
    )
    return escape_markdown(text)


_media_stats_video_text = """
>> {caption_text}

Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:
- ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ²: {stats.comment_count_current}
- Ğ›Ğ°Ğ¹ĞºĞ¾Ğ²: {stats.like_count_current}
- ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¾Ğ²: {stats.play_count_current}

Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ {stats.created_at:%d.%m.%Y %H:%M}
- ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ²: {stats.comment_count_difference}
- Ğ›Ğ°Ğ¹ĞºĞ¾Ğ²: {stats.like_count_difference}
- ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¾Ğ²: {stats.play_count_difference}
"""

_media_stats_text = """
>> {caption_text}

Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:
- ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ²: {stats.comment_count_current}
- Ğ›Ğ°Ğ¹ĞºĞ¾Ğ²: {stats.like_count_current}

Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¾Ñ‚ {stats.created_at:%d.%m.%Y %H:%M}
- ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ²: {stats.comment_count_difference}
- Ğ›Ğ°Ğ¹ĞºĞ¾Ğ²: {stats.like_count_difference}
"""

def build_media_stats_text(
    stats: InstagramMediaStatsSchema, media: TrackingMedia
) -> str:
    if media.caption_text:
        caption_text = descape_markdown(media.caption_text).replace("\n", "\n>> ")
        total_length = len(escape_markdown(_media_stats_video_text.format(caption_text=caption_text, media=media, stats=stats)))
        if total_length > 1024:
            caption_text = caption_text[:-(total_length - 1024)]
    else:
        caption_text = ""
    if stats.play_count_current is not None:
        return escape_markdown(_media_stats_video_text.format(caption_text=caption_text, media=media, stats=stats))
    return escape_markdown(_media_stats_text.format(media=media, stats=stats, caption_text=caption_text))


_subscription_info_text = """
ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ğ´Ğ¾ {subscription.expire_at:%d.%m.%Y %H:%M}
"""

subscription_paywall_text = """
Ğ¢Ñ‹ ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑˆÑŒ Ğ½Ğ°ÑˆĞµĞ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸, Ğ¸ ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ĞĞ¾ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²ÑŒ, ĞºĞ°Ğº Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ñ Premium-Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸.

**Ğ¡ Premium Ñ‚Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸ÑˆÑŒ:**

ğŸ“Š ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ğ±Ğ·Ğ¾Ñ€ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ² Ğ¸ Ğ¾Ñ‚Ğ¿Ğ¸ÑĞ¾Ğº. ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ¹ Ñ€Ğ¾ÑÑ‚ Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸.
â¤ï¸ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ»Ğ°Ğ¹ĞºĞ¾Ğ² Ğ¸ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ². Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ½ÑÑ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ²Ğ°ÑˆĞ¸Ñ… Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ².
ğŸ“ Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ². Ğ’Ñ‹ÑĞ²Ğ¸ ÑĞ°Ğ¼Ñ‹Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸.
ğŸ“ˆ Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸. ĞĞ½Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ²Ğ°Ğ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ.

**ĞŸĞ¾Ğ²Ñ‹ÑÑŒ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ ÑĞ²Ğ¾ĞµĞ³Ğ¾ Instagram â€” Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ¹ Ğ´Ğ»Ñ ÑĞµĞ±Ñ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Premium ÑƒĞ¶Ğµ ÑĞµĞ¹Ñ‡Ğ°Ñ!**
"""


def build_subscription_info_text(subscription: Subscription) -> str:
    return _subscription_info_text.format(subscription=subscription)


def media_display_url_to_emoji(display_url: str | None) -> str:
    if display_url is None:
        return ""
    if display_url.startswith("[") and display_url.endswith("]"):
        return "ğŸ"
    media_type = mimetypes.guess_type(display_url)[0]
    if media_type is None:
        return ""
    elif media_type.startswith("video/"):
        return "ğŸ¥"
    elif media_type.startswith("image/"):
        return "ğŸ“·"
    return ""
